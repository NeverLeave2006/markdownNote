# 课前导读
# 微服务介绍
## 1.1 单体应用架构
优点：
    架构图简单易懂
    对于一些小型项目来讲，开发，维护简单
    部署一个单点tomcat上，后期维护方便
缺点：
    对大型项目来说，维护困难
    模块之间紧密耦合，单点容错率低
    无法对一个模块进行水平扩展或者优化

## 1.2 垂直应用架构
优点：
    系统拆分了就可以进行水平扩展和优化了
    提高了单点容错率
缺点：
    系统之间无法相互调用
    会有一部分代码重复

## 1.3 分布式架构
优点：
    抽取公共代码为服务层，增强代码复用性
缺点：
    调用关系复杂，维护困难

## 1.4 SOA架构
引入服务治理中心(Service Oriented Architecture,面向服务的架构)
优点：
    使用服务治理中心帮我们维护复杂的调用关系
缺点：
    服务有依赖性，可能会因为一个服务导致多个系统不可用(拆分的不够彻底)

## 1.5 微服务架构(服务的原子化拆分)
优点：
- 服务原子化拆分，独立打包，部署和升级，保证每个微服务清晰的任务划分，利于扩展
- 微服务之间采用Restfil等轻量级http协议相互调用
缺点：
- 分布式系统开发的技术成本高(容错，分布式事务等)

## 微服务架构常见问题
问题:
1. 这么多小的服务，我们应该如何管理他们?
2. 这么多小的服务，它们之间应该如何调用?
3. 这么多小服务。客户端如何来访问他们?
4. 这么多小服务，如果出现问题了，那么作为服务自身来讲，应该如何处理?
5. 这么多小服务，如果中间某个环节出问题了，作为程序员来讲，应该如何排查?

## 微服务架构的常见概念
### 服务治理
服务治理就是进行服务的自动化管理，其核心是服务的自动注册与发现
服务注册: 服务实例将自身服务信息注册到注册中心
服务发现：服务治理通过注册中心。获取到注册到其中的服务实例的信息，通过这些信息去请求它们提供的服务
服务剔除: 服务注册中心将出问题的服务自动提出到可用列表之外，使其不会被调用到。

### 服务调用
在微服务架构中，通常存在多个服务之间的远程调用的需求。目前主流的远程调用技术有基于HTTP的RESTful接口以及基于TCP的RPC协议
- REST(Representational State Transfer)
  这是一种HTTP调用的格式，更标准，更通用，无论哪种语言都支持HTTP协议
- RPC(Remote Promote Call)
  一种进程间通信方式。允许像调用本地服务一样调用远程服务。RPC框架的主要目标是让远程服务调用更简单,透明。RPC框架负责屏蔽底层的传输方式，序列化方式和通信细节。开发人员在使用的时候只需要了解谁在什么位置提供了什么样的远程服务接口即可，并不需要关心底层通信细节和调用过程
区别与联系

|比较项|Restful|RPC|
|---|---|---|
|通讯协议|HTTP|一般使用TCP|
|性能|略低|较高|
|灵活度|高|低|
|应用|微服务架构|SOA架构|

### 服务网关
随着微服务的不断增多，不同的微服务一般会有不同的网络地址，而外部客户端可能需要调用多个服务的接口才能完成一个业务需求，如果让客户端直接与各个微服务通信可能出现：
- 客户端需要调用不同的url地址，增加难度
- 在一定的场景下，存在跨域请求的问题
- 每个微服务都需要进行单独的身份认证

针对这些问题，API网关顺势而生

    API网关的字面意思是将说要的API同意接入API网关层，由网关层统一接入和输出。一个网关的基本功能有：统一接入，安全防护，协议适配，流量管控，长短链接支持，容错能力。有了网关之后，各个API服务提供团队可以专注于自己的业务逻辑处理，而API网关更专注于安全，流量，路由等问题。

### 服务容错
    在微服务当中，一个请求经常会涉及到调用好几个服务，如果其中某个服务不可用，没有做服务容错的话，极有可能会造成一连串的服务不可用，这就是雪崩效应。

    我们没法预防雪崩效应的发生,只能尽可能去做好容错。服务器容错的三个核心思想是:
- 不被外界环境影响
- 不被上游请求压垮
- 不被下游相应拖垮

### 链路追踪
随着微服务架构的流行，服务按照不同的维度进行拆分，一次请求往往需要涉及多个服务。互联网应用构建在不同的软件模块集上，这些软件模块，有可能是由不同的团队开发，可能使用不同的编程语言来实现，有可能布置在几千台服务器，横跨多个不同的数据中心。因此，就需要对一次请求涉及的多个服务器链路进行日志记录，性能监控即链路追踪

## 微服务解决方案
- Apache ServiceComb
- SpringCloud
- **SpringCloud Alibaba**
  - 主要功能
    - 服务限流降级: 默认支持WebServlet,WebFlux,OpenFeign,RestTemplate,Spring Cloud Gateway, Zuul, Dubbo和RocketMQ限流降级功能的接入，可以在运行时通过控制台实时修改限流降级规则，还支持查看限流降级Metrrics监控
    - 服务注册与发现: 适配Spring Cloud服务注册与发现标准，默认集成Ribbon的支持
    - 分布式配置管理: 支持分布式系统中的外部化配置，配置更改时自动刷新
    - 消息驱动能力: 基于Spring Cloud Stream 为微服务应用构建消息驱动能力
    - 阿里云对象存储: 阿里云提供的海量，低成本，高可靠的云存储服务。支持任何应用，任何时间，任何地点存储和访问任意类型的数据
    - 分布式任务调度: 提供秒级，精准，高可靠，高可用的定时(基于Cron表达式)任务调度服务。同时提供分布式任务执行模型，如网格任务。网格任务支持海量子任务均匀分配到所有Worker(schedulerx-client)上执行。
    - 阿里云短信服务: 覆盖全球的短信服务，友好，高效，智能的互联化通讯能力，帮助企业迅速搭建客户触达通道。

  - 组件:
    - Sentinel: 把流量作为切入点，从流量控制，熔断降级，系统负载保护等多个维度保护服务的稳定性
    - Nacos: 一个更易于构建云原生应用的动态服务发现，配置管理和服务管理平台
    - RocketMQ: 一款开源的分布式消息系统，基于高可用分布式集群技术，提供低延时的，高可靠的消息发布与订阅服务。
    - Dubbo: Apache Dubbo 是一款高性能Java RPC框架
    - Seata: 阿里巴巴开源产品，一个易于使用的高性能微服务分布式事务解决方案
    - Alibaba Cloud ACM: 一款在分布式架构环境中对应用配置进行集中管理和推送的应用配置中心产品




# 微服务环境搭建(环境基础)

技术选型
maven
数据库: Mysql5.7
持久层: SpringData JPA
其他： SpringCloud Alibaba技术栈

模块设计
springcloud-alibaba父工程

shop-common公共模块[实体类]

shop-user用户微服务[端口:807x]

shop-product 商品微服务[端口:808x]

shop-order 订单微服务[端口:809x]

用户下单: 客户发起请求 告诉网站 需要买几件 什么商品

# 服务治理

问题：
1. 一旦服务提供者的地址变化了，我们就不得不去修改服务调用者的代码
2. 一旦服务提供者做了集群，服务调用者无法实现负载均衡去调用
3. 一旦微服务越来越多，如何来管理这个服务清单就成了问题

什么是服务治理
服务治理是微服务架构中最核心最基本的模块。用于实现各个微服务的自动化注册与发现
- 服务注册: 在服务治理框架中，都会构建一个注册中心，每个服务单元向注册中心登记自己提供服务的详细信息。并在注册中心形成一张服务的清单，服务注册中心需要以心跳的方式去监听清单中的服务是否可用，如果不可用，需要在服务清单中剔除不可用的服务
- 服务发现: 服务调用方向注册中心咨询服务，并获取所有服务的实例清单，实现对具体服务实例的访问

常见注册中心
- Zookeeper
  Zookeeper是一个分布式服务框架, 是Apache Hadoop的一个子项目, 它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如: 统一命名服务，状态同步服务，集群管理，分布式应用配置项的管理等。
- Eureka
  Eureka是Springcloud NetFlix 中的重要组件，主要作用就是做服务注册和发现。目前已经闭源
- Consul
  Consul是基于GO语言开发的开源工具，主要面向分布式，服务化的系统提供服务注册，服务发现和配置管理的功能。Consul的功能都很实用，其中包括：服务注册/发现，健康检查，Key/Value存储，多数据中心和分布式一致性保证等特性。Consul本身只是一个二进制的可执行文件，所以安装部署都非常简单，只需要从官网下载后，再执行对应的启动脚本即可
- Nacos
  Nacos是一个更易于构建云原生应用的动态服务发现，配置和服务管理平台。它是Spring Cloud Alibaba组件之一，负责服务注册发现和服务配置，可以认为Nacos=Eureka+config



# 服务容错
# 服务网关
# 链路追踪
# 消息驱动
# 短信服务
# 服务配置
# 分布式事务