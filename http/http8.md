# Web安全威胁浅析

### web应用的概念

- Web应用是由动态脚本,编译过的代码等组合而成

- 它通常架设在web服务器上,用户在web浏览器上发送请求

- 这些请求使用HTTP协议,由Wen应用和企业后台的数据库及其它动态内容通信

### Web应用的三层架构

- 典型的web应用通常是标准的三层架构模型

浏览器---（Web页面/表示层----业务逻辑层----数据层）----数据库服务器

### 日常生活中的"安全"

- 为什么我们登陆时经常要求我们输入一个验证码?

防止暴力破解

- 在一个网站上长时间没有操作为什么session会失效?

避免被盗用

### 典型安全模型

- 为什么北京地铁拥堵现象，容易发生安全问题？

- 如果是你发挥天马行空的想象有什么办法解决？

## WASC的定义

- Web Application Security Consortium

- 是一个由安全专家,行业顾问和诸多组织的代表组成的国际团体

- 他们负责为www.制定被广为接受的应用安全标准

## WASC将Web应用安全威胁分为六大类

1. Authentication(验证): 用来确认某用户、服务或是应用身份的攻击手段

2. Authorization(授权): 用来决定是否某用户、服务或者应用具有执行请求动作必要权限的攻击手段

3. Client-Side Attacks(客户侧攻击):用来扰乱或是探测Web站点用户的攻击手段

4. Command Execution(命令执行):在Web站点上执行远程命令的攻击手段

5. Information Disclosure(信息暴露): 用来获取web站点具体系统信息的攻击手段

6. Logical Attacks(逻辑性攻击):用来扰乱或是探测web应用逻辑流程的手段

## OWASP的定义

- Open Web Application Securtiy Project

- 该组织致力于发现和解决不安全涡轮应用的根本原因

- 他们最重要的项目之一是"web应用的十大安全隐患"

- 总结了目前web应用最常受到十种攻击手段,并且按照攻击发生的概率进行了排序

注入:

失效的身份认证:

敏感信息的泄露:

XML外部实体:执行远程代码

失效的访问控制:

安全配置错误:

跨站脚本(XSS):

不安全的反序列化: 不安全的反序列化会导致远程代码执行

使用含有已知漏洞的组件:

不足的日志记录和监控:


## 会话管理机制

### 会话管理概述

- 绝大多数web应用程序中，会话管理器只是一个基本的**安全组件**

- 会话管理在应用程序执行登录功能时显得特别重要

- 因为，它可以在用户通过请求提交他们的证书后，持续向应用程序保证任何特定用户身份的**真实性**

- 由于会话机制所发挥的关键作用，他们成为针对应用程序的**恶意攻击**的主要目标

- 若攻击者能够**破坏**应用程序的会话管理，他就能轻易避开实施的验证措施，不需用户证书即可伪装成其他应用程序用户

- 如果攻击者以这种方式攻破一个管理用户，那么他就能够控制整个应用程序

### 会话令牌生成漏洞

- 一些**会话令牌**通过用户的用户名或电子邮件地址转换而来，或者使用与其相关的其他信息创建

- 这些信息可以以某种方式进行**编码或模糊处理**，也可以与其他数据结合在一起

知道令牌规则，攻击者可以枚举大量用户名来生成可能有效令牌实施攻击

1. 令牌可预测

- 一些会话令牌并不包含与某个特殊用户有关的任何有意义的数据，但可以由于它们包含某种顺序或模式，允许攻击者通过几个令牌样本即可推断出应用程序最近发布的其他有效令牌，因此具有**可预测性**

- 即使推断过程需要做出大量尝试，并且成功率极低(例如，每1000次尝试可以得到一个有效令牌)，**自动攻击工具**也仍然能够利用这种缺陷在很短的时间内确定大量有效令牌

类型:
- 隐含序列

- 时间依赖

- 生成随机数强度不足

- 计算机中的数据极少完全随机

- 因此，由于某种原因需要随机数据, 一般通过**软件**使用各种技巧生成**伪随机数据**

- 所使用的一些算法生成看似随机并且在可能的数值范围内平均分布的序列

### 会话终止攻击

尽可能**缩短**一个**会话的寿命**可降低攻击者截获、猜测后滥用有效会话令牌的可能性

其次，如果用户不再需要现有会话，终止会话为用户提供一种使其失效的途径，再进一步降低上述可能性的同时，在某种程度上确保**共享计算环境**中会话的安全

- 一些应用程序并不实施有效的会话终止功能

- 会话一旦建立，它在收到最后请求后许多天内也仍然有效，直到服务器最终将其清除

- 有些时候，退出功能实际上并不能帮助服务器终止会话。

- 即使服务器从用户的浏览器中**删除令牌**（例如通过发布一个星空令牌的Set-Cookie指令）

- 然而，如果用户继续提交这个令牌，服务器仍然接受它

- 最糟糕的情况：当用户单击"退出"按钮时,应用程序并不与服务器通信,因此**服务器不采取任何行动**

- 相反，应用程序执行一段客户端脚本**清空用户的cookie**，在随后的请求中将用户返回到登录页面

- 访问这个cookie的攻击者就能使用会话,好像用户从未退出一样


### 会话劫持攻击

- 攻击者通过**网络嗅探**、**XSS攻击**等方式获取被攻击者会话令牌的攻击方式

- 这种攻击方式最简单也最有效，也是目前最多采用的攻击方式

防御:

1. 使用HTTPS

- 令牌只能通过https传送

- 如果使用HTTP cookie传送令牌(大多数情况下),应该将这些cookie标记为**secure**，以防止用户浏览器通过HTTP传送它们。

2. 增加软硬会话过期

- 软会话过期，它指的是用户在一定时间内与应用系统没有交互，则**会话过期**,也就是我们常说的**session失效**

- **硬会话过期**，他指的是用户登录到系统中经过一定时间后，不管用户做什么，该会话都会过期

3. 提供完善的注销功能

- 用户可以手动的使用当前会话过期这就是我们在几乎所有网站上看到的logo out按钮

- Tips:要保证注销不存在会话终止漏洞


## SQL 注入
### SQL 注入原理

- 几乎每一个web应用都需要使用**数据库**来保存操作所需的各种信息

- 所以web程序经常会建立用户提交的数据**SQL语句**

- 如果,建立这种语句的方法**不安全**,那么应用程序就很容易受到SQL注入的攻击

- 在严重的情况下，攻击者可以利用SQL注入读取甚至修改数据库中保存的所有数据

- 用户可以提交一段**数据库查询代码**,根据程序返回的结果,获得某些他想得知的数据。

- 这就是所谓的SQL injection，即SQL注入。

### SQL注入危害

- **探知数据库**的具体结构,为进一步攻击做准备

- **泄露数据**,尤其是机密信息,账户信息等

- **取得更高权限**，来修改表数据甚至是内部结构

Csdn密码泄露，如家信息泄露等事件告诉我们，其实SQL攻击离我们并不遥远


### SQL注入防御

1. 参数化查询

- 参数化查询是对SQL注入根本性的**防御策略**，也叫预处理语句，在建立一个包含用户输入的SQL语句时分为两步：

    1. 指定查询结构，用户输入预留占位符
    2. 指定占位符的内容

## 跨站脚本攻击

### XSS攻击原理

- 跨站脚本攻击(Cross Site Scripting),XSS是一种经常出现在web应用中的计算机安全漏洞

- 它允许恶意Web用户将代码植入到提供给其他用户使用的页面中，其他用户在观看网页时，恶意脚本就会执行

- 类公司通常通过注入HTML或js等脚本发动攻击。

-  攻击成功后，攻击者可以得到私密网页内容和cookie等

### XSS攻击危害

- **盗取各类用户账号**，如机器登账号，用户网银账号，各类管理员账号。

- **控制数据**，包括读取、篡改、添加、删除企业敏感数据的能力

- 盗取企业重要的具有**商业价值**的资料

- 非法转账

- 强制发送网站挂马

- 控制受害者机器向其它网站发起攻击

### XSS攻击真实案例

- 2005年，一名叫做samy的用户发现了Myspace的XSS漏洞，他在用户资料页面插入了一些javascript的脚本

    - 如果一个用户查看了他的用户资料，这段脚本就会被执行
    - 脚本包含两方面内容，一是把samy加为好友,二是将上面说的脚本复制到受害者自己的用户资料页面中
    - 于是,所有受害者用户资料的用户也会成为受害者
    - 一个基于存储是XSS攻击的蠕虫迅速扩散，几个小时内samy收到了近百万个好友申请

    - 为此,Mysapace被迫关站，修复了反XSS过滤机制并且从所有用户的资料中删除了含有恶意脚本的内容

- Apache攻击事件

    - 2010年，Apache Foundation被攻击者利用其问题追踪应用程序中的漏洞，通过反射式XSS攻击攻破
    - 首先，攻击者发布了一个使用重定向服务进行模糊处理的链接，该链接指向一个利用上述XSS漏洞获取用户登录会话令牌的URL
    - 如果管理员点击该链接，其会话将被攻破，攻击者获得对应程序的管理访问权限
    - 然后，攻击者修改某个项目的设置，将该项目的上传文件夹更改为应用程序的web根目录中的可执行目录
    - 随后，攻击者向此文件夹上传一个木马登录表单，从而获取特权用户的账户和密码

### XSS分类

根据XSS的攻击方式不同，我们可以把XSS分为如下三大类

1. 反射式XSS
2. 存储式XSS
3. 基于DOM的XSS


#### 反射式XSS

- 也称为**非永久性XSS**,是目前最流行的XSS攻击

- 它出现在服务器直接使用客户端提交的数据，如URL数据HTML表单中提交数据等，并且没有对数据进行无害化处理

- 如果提交的数据中含有HTML控制字符而没有被正确处理，那么一个简单的插XSS攻击就会发生

- 典型的反射式攻击可通过一个邮件或中间网站，诱饵是一个看起来可信任的站点的链接，其中包含XSS攻击脚本

- 如果信任的网站没有正确处理这个脚本，用户点击后就会导致浏览器执行含有恶意攻击的脚本

这个简单的例子的测试有助于告诉我们两个问题

- 首先， input的值可以用任何返回给浏览器的数据替代
- 其次，无论服务器应用程序如何处理这些数据，都无法阻止提交JavaScript代码，一旦该页面显示，这些代码就会执行

#### 存储式XSS

- 也称为永久性XSS，危害更大

- 攻击者将攻击脚本上传到web服务器上，使得所有访问该页面的用户命名信息泄露的可能，其中也包括了web服务器管理员

存储是XSS多发工在最终显示给其他用户的位置,包含

- 个人信息字段，如姓名、地址、电子邮件、电话等

- 文档、上传文件及其他数据的名称

- 提交给应用程序管理员的反馈或问题

- 向其他应用程序用户传递的信息、注释、问题等

- 在用户之间共享的上传文件内容

> 典型的存储式XSS攻击过程
> - 我拥有一个web站点，该站点允许用户发布信息/浏览已经发布的信息。
> 
> - 你注意到我的站点具有存储式XSS漏洞
> 
> - 于是你发布一个热点信息，利用该漏洞获取用户信息，吸引其他用户纷纷阅读
> 
> - 任何其他人浏览该信息，其会话cookies或者其他信息将被你盗走

#### 基于DOM的XSS的攻击

- 反射式XSS攻击和存储式XSS攻击都是服务器端提取用户提交的数据

- 并且以不安全的方式将其返回给用户

- 鉴于DOM的攻击仅仅通过Javascript的方式执行

- 也就是说系统攻击经常发生在应用程序每次返回相同的静态HTML,而通过客户端JavaScript的动态生成信息,并不会跟服务端交互获取的时候.

##### XSS攻击载荷

1. 会话令牌

- XSS攻击最普遍的方式
- 截取一名受害者的会话令牌，劫持他的会话，进而作为受害者的身份来使用应用程序，执行任意操作并占有该用户的账户

2. 虚拟置换

- 这种攻击需要在一个web应用程序页面注入恶意数据,从而向应用程序的用户传送误导性信息

- 包括简单地向站点注入HTML，或者使用脚本注入精心设计的内容。

- 攻击者实际上没有修改保存在服务器上的内容，而是利用程序处理并显示用户提交的输入方面的缺陷实现置换

3. 注入木马

- 所以造成的后果远比虚拟置换更严重，他在易受攻击的应用程序中注入实际运行的功能，旨在欺骗终端用户执行某种有害操作(如输入敏感数据)。

- 随后将他们传送给攻击者。

- 在一个明显的攻击中，攻击者的注入功能向用户展示一个木马登录表单，要求他们向攻击者控制的服务器提交他们自己的证书。

- 如果有技巧熟练的攻击者实施，这种攻击还允许用户无缝登录到其真正的应用程序中，以便他们不会发觉访问过程中的任何反常情况

- 然后攻击者就可以自由使用受害者的证书实现自己的目的

- 这种类型的有效载荷非常适于用在钓鱼攻击中，向用户传送一个经过专门设计、连接格式应用程序的URL，并要求他们正常登录以访问这个URL

#### XSS防御措施

1. 输入验证

- 如果应用程序在某个位置收到的用户提交数据将来有可能被复制到它的响应中,应用产生应根据这种情形对这些数据执行尽可能严格地确认。

- 需要确认的潜在特性包括以下几点。

    - 数据不是太长

    - 数据仅包含某组合法字符

    - 数据与一个特殊的正规表达式相匹配

    - 根据应用程序希望在每个字段中收到的数据类型，应尽可能限制性的对姓名、电子邮件地址、账号等应用不同的确认规则

2. 输出编码

- 如果应用程序将某位用户或者第三方提交的数据复制到它的响应中，那么应用程序应对这些数据进行HTML编码，以进化可能的恶意字符

- HTML编码指用对应的HTML实体替代字面量字符。这样做可确保浏览器安全处理可能为恶意的字符，把它们当作HTML文档的内容而非结构处理。

- 经常造成问题的字符HTML编码如下：

```txt
"->&quot;
‘-》&#x27;
<->&lt;
>->&gt;
/->x2f
```

- 应用程序之所以结合使用输入确认与输出进化,原因在于这种方法能够提供两层防御:如果其中一层被攻破,另一层还能提供一些保护

- 结合这两种技巧,应用程序就能够获得额外的保护,即攻击者发现其中一种过滤存在缺陷,另一种过滤仍然能够阻止他们实施攻击。

- 在这两种防御中，输出确认作为重要，必不可少。实施严格的输入确认应被视为一种次要故障恢复。


## CSRF攻击

### CSRF攻击原理

- CSRF(Cross site request forgery，跨站请求伪造)，也被称为”one click attack“，或者session riding，通常缩写为CSRF或者XSRF,是一种对网站的恶意利用

- 听起来像跨站脚本(XSS),但他与XSS非常不同,并且攻击方式几乎相左

- XSS利用站点内的信任用户(受害者),而CSRF通过伪装来自受信任用户的请求来利用受信任的网站

- 通过社会工程学的手段(如通过电子邮件发送一个链接)来蛊惑受害者进行一些敏感性的操作,如修改密码，修改email，转账等，而受害者还不知道他已经中招

### CSRF攻击危害

- CSRF的破坏力依赖于受害者的权限

- 如果受害者只是个**普通的用户**,则一个成功的CSRF攻击会危害用户的数据以及一些功能

- 如果受害者具有**管理员权限**,则一个成功的CSIF攻击甚至会威胁到整个网站的安全

- 与XSS攻击相比，CSRF攻击往往不太流行(因此对其进行防范的资源也相当稀少)和难以防范

- 故被认为比XSS更具危险性，所以CSRF在业内有个响当当的名字————沉睡的巨人

#### CSRF攻击传递


- Alice登录了一个金融网站mybank.com

- Bob知道这个金融网站mybank.com，并且发现这个网站的转账功能有CSRF漏洞

- 于是， Bob在myblog.com上发表了一条blog，这个blog支持img自定义功能

- 所以Bob插入了这么一行HTML代码：
```html
<img src="http://mybank.com/trasnkferMoney.jsp?to=Bohb&cash=3000" width="1" height="1" border="0"/>
```

- Alice在自己的浏览器上打开了另一个标签页也正好读到这个blog

- 于是Alice的账户就不知不觉地向Bob的账户转账了三千元而他却毫不知情

#### 攻击过程深度剖析

1. Web浏览器对应cookie和HTTP身份验证之类的会话信息的处理方式:

- 目前，浏览器会自动的发送标识用户对话的信息而无需用户干预

- 换句话说，当浏览器发送这些身份信息的时候用户根本感觉不到

- 假设站点a上面有一个web应用程序，并且受害者正好已经在该站点上通过了身份认证，这时响应消息中就会有cookie来记录这个信息

> 这个Cookie的作用是什么呢?
> - 主要是被站点作为用户会话的标志, 其实如果站点收到了带有受害者cookie的请求,那么他就会把这个请求看作是与登录的受害者发来的.
> - 一般情况下,浏览器收到站点设置的cookie之后, 每当向该站点发送请求的时候,浏览器都会"自动的"连同该cookie一同发出

2. 应用程序赖以管理会话的信息对浏览器的透明性问题

-  为了提高web应用的便利性，用来管理会话的信息，如Cookie或者基于HTTP的身份验证(如HTTP基本认证，非基于表单的z认证)等敏感信息,都是由**浏览器来存放**的。

- 并且每当向需要身份验证的应用程序发送请求时自动捎带上

- 也就是说，**浏览器可以访问会话管理信息**，如果web应用程序完全依赖于这类信息来识别一个用户会话，就为跨站请求伪造创造了条件。

- 因为web应用程序不会判断这个请求到底是否合法用户发送的

#### CSRF攻击预防

1. 增加一些确认操作

- 比如说上面的转账功能，当用户调用API进行转账的时候，弹出一个对话框，例如：你确定转账两千元吗？

- 这样CSRF受害者就可以知道他可能骗招了

2. 重新认证

- 在做一些敏感操作的时候,要求用户重新输入密码进行二次验证,只有正确了才能进行操作

- 这种做法显然更安全,但对于用户看起来不是特别友好————毕竟是增加了一步操作

- 所以安全和易用性，我们有时候不得不做出取舍


3. 使用Token

- 在用户刚登陆的时候，产生一个新的不可预知的CSRF token,并且把此token存放在用户的session中

- 在任何一个需要保护的表单中,增加一个隐藏的字段来存放这个token

- 对于需要保护的URL,增加一个参数来存放次此Token

- 提交此请求的时候,在服务器端检查提交的token与用户session中的Token是否一种，如果一致，继续处理请求，否则返回一个错误信息给用户

- 在用户退出或者session过期的时候，用户信息（包括CSRF token）从session中移除并且销毁session



/data/data/com.termux/files/home/storage

rtmp://192.168.0.102:11935/vod/a.mp4
